<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <title>ğŸ“± ã€ç™¾åŠ¨ç½‘ã€‘çŸ­ä¿¡å…‘æ¢ç æå–</title>
    <style>
        body{font-family:"Microsoft YaHei",Arial,Helvetica,sans-serif;margin:24px;background:#fafafb;color:#222}
        h1{font-size:20px;margin-bottom:10px}
        textarea#smsInput{width:100%;height:180px;padding:10px;font-size:14px;border:1px solid #ddd;border-radius:6px;resize:vertical}
        button{padding:8px 12px;margin-right:8px;border:none;border-radius:6px;background:#007bff;color:#fff;cursor:pointer}
        button:hover{opacity:0.92}
        .green{background:#28a745}
        .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.06);margin-top:16px}
        .catHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .catTitle{font-weight:600;color:#0366d6}
        textarea.codes{width:100%;min-height:80px;padding:8px;font-family:monospace;font-size:13px;white-space:pre-wrap;resize:vertical}
        .invalid{color:#b02a37;background:#fff0f0;padding:8px;border-radius:6px;margin-top:12px}
        .small{font-size:13px;color:#666}
        .count{font-weight:600;margin-left:8px;color:#333}
        .btn-copy{padding:6px 10px;border-radius:6px;background:#20b2aa;color:white;border:none;cursor:pointer;margin-left:8px}
        .points{font-weight:bold;color:#e67e22;margin-left:10px;}
        .total{font-size:18px;font-weight:bold;margin-top:10px;color:#c0392b}
        #summary{margin-bottom:20px}
    </style>
</head>
<body>
<h1>ğŸ“± çŸ­ä¿¡å…‘æ¢ç æå–</h1>

<textarea id="smsInput" placeholder="æŠŠçŸ­ä¿¡æ•´æ®µç²˜è´´åˆ°è¿™é‡Œï¼ˆæ”¯æŒå¤šæ¡çŸ­ä¿¡ä¸€æ¬¡æ€§ç²˜è´´ï¼‰..."></textarea>
<br/>
<button onclick="extractCodes()">æå–å…‘æ¢ç </button>
<button class="green" onclick="copyAll()">å¤åˆ¶æ‰€æœ‰å…‘æ¢ç </button>

<!-- æ±‡æ€»åŒºåŸŸ -->
<div id="summary">
    <div id="total" class="total"></div>
    <div id="invalids" class="invalid"></div>
</div>

<div id="output"></div>

<script>
    function cleanCodeRaw(s){
        if(!s) return "";
        let t = s.replace(/^[\s\W]+|[\s\W]+$/g, "");
        t = t.replace(/[ã€‚ã€‚,ï¼Œ;ï¼›\s]/g, "");
        t = t.replace(/[^A-Za-z0-9]/g, "");
        return t;
    }

    function extractCodes(){
        const raw = document.getElementById("smsInput").value || "";
        const out = document.getElementById("output");
        out.innerHTML = "";
        document.getElementById("total").innerHTML = "";
        document.getElementById("invalids").innerHTML = "";

        if(!raw.trim()){
            out.innerHTML = '<div class="card"><p class="small">è¯·å…ˆç²˜è´´çŸ­ä¿¡å†…å®¹ï¼Œç„¶åç‚¹å‡»ã€Œæå–å…‘æ¢ç ã€ã€‚</p></div>';
            return;
        }

        const segments = raw.split(/(?=ã€ç™¾åŠ¨ã€‘)/g).map(s=>s.trim()).filter(Boolean);
        const grouped = {};
        const invalids = [];
        const lekePointsMap = { N3:159, N4:179, N5:199, N7:239, N10:299 };

        segments.forEach((seg, idx) => {
            const segCleanTail = seg.replace(/ã€[^ã€‘]*ã€‘/g, "");
            const codeSectionMatch = segCleanTail.match(/å…‘æ¢ç [:ï¼š]([\s\S]*?)(?:ã€‚|$)/);
            const codeSection = codeSectionMatch ? codeSectionMatch[1] : "";
            if(!codeSection.trim()) return;

            const rawCodes = codeSection.split(/[,ï¼Œ\n\r;ï¼›\s]+/).map(x=>x.trim()).filter(Boolean);

            if(/è¶…çº§çŒ©çŒ©/.test(seg)){
                const priceMatch = seg.match(/å¥èº«æ“è¯¾\s*([0-9]{1,4})\s*å…ƒ/);
                const price = priceMatch ? parseInt(priceMatch[1]) : 0;
                const cat = price ? `è¶…çº§çŒ©çŒ© ${price}å…ƒè¯¾ç¨‹` : "è¶…çº§çŒ©çŒ© æœªçŸ¥è¯¾ç¨‹";
                if(!grouped[cat]) grouped[cat] = {codes:[], pointsPer:price, count:0, points:0};
                rawCodes.forEach(rc=>{
                    const c = cleanCodeRaw(rc);
                    if(c.length===16){
                        grouped[cat].codes.push(c);
                        grouped[cat].count++;
                    } else {
                        invalids.push({code:rc,cleaned:c,reason:`é•¿åº¦åº”ä¸º16ï¼ˆå®é™… ${c.length}ï¼‰`,segment:idx+1,category:cat});
                    }
                });
                grouped[cat].points = grouped[cat].pointsPer * grouped[cat].count;
            }
            else if(/ä¹åˆ»è¿åŠ¨/.test(seg)){
                const levelMatch = seg.match(/ä¹åˆ»è¿åŠ¨-([^,ï¼Œ\n]+)/);
                const cat = levelMatch ? `ä¹åˆ»è¿åŠ¨ - ${levelMatch[1].trim()}` : "ä¹åˆ»è¿åŠ¨ - æœªçŸ¥ç±»åˆ«";
                const nMatch = cat.match(/N(\d+)/);
                const nKey = nMatch ? "N"+nMatch[1] : null;
                const pointsPer = nKey && lekePointsMap[nKey] ? lekePointsMap[nKey] : 0;
                if(!grouped[cat]) grouped[cat] = {codes:[], pointsPer, count:0, points:0};
                rawCodes.forEach(rc=>{
                    const c = cleanCodeRaw(rc);
                    if(c.length===10){
                        grouped[cat].codes.push(c);
                        grouped[cat].count++;
                    } else {
                        invalids.push({code:rc,cleaned:c,reason:`é•¿åº¦åº”ä¸º10ï¼ˆå®é™… ${c.length}ï¼‰`,segment:idx+1,category:cat});
                    }
                });
                grouped[cat].points = grouped[cat].pointsPer * grouped[cat].count;
            } else {
                rawCodes.forEach(rc=>{
                    const c = cleanCodeRaw(rc);
                    invalids.push({code:rc,cleaned:c,reason:`æœªè¯†åˆ«æœåŠ¡`,segment:idx+1,category:"æœªçŸ¥"});
                });
            }
        });

        let totalPoints = 0;
        Object.keys(grouped).forEach(cat=>{
            totalPoints += grouped[cat].points;
        });

        // ä¸Šæ–¹æ˜¾ç¤ºæ€»ç§¯åˆ†
        document.getElementById("total").textContent = `æ€»æ¶ˆè€—ç§¯åˆ†ï¼š${totalPoints}`;

        // ä¸Šæ–¹æ˜¾ç¤ºæ— æ•ˆå…‘æ¢ç 
        if(invalids.length>0){
            document.getElementById("invalids").innerHTML = `<strong>è¢«è¿‡æ»¤/æ— æ•ˆå…‘æ¢ç ï¼ˆå…± ${invalids.length} ä¸ªï¼‰</strong>
        <pre>${invalids.map(it=>`æ®µ${it.segment} | ç±»åˆ«:${it.category} | åŸç :"${it.code}" | æ¸…æ´—å:"${it.cleaned}" | ${it.reason}`).join("\n")}</pre>`;
        }

        // ç”Ÿæˆæ¯ç±»å…‘æ¢ç å¡ç‰‡
        Object.keys(grouped).forEach(cat=>{
            const {codes, pointsPer, count, points} = grouped[cat];
            const card = document.createElement("div");
            card.className = "card";

            const header = document.createElement("div");
            header.className = "catHeader";
            header.innerHTML = `
        <div class="catTitle">${cat}
            <span class="count">(${count}ä¸ª)</span>
            <span class="points">ç§¯åˆ†æ¶ˆè€—: ${pointsPer} Ã— ${count} = ${points}</span>
        </div>
        `;
            const copyBtn = document.createElement("button");
            copyBtn.className = "btn-copy";
            copyBtn.textContent = "å¤åˆ¶æœ¬ç±»";

            const copiedSpan = document.createElement("span");
            copiedSpan.className = "copied";
            copiedSpan.style.marginLeft="6px";
            copiedSpan.style.display = "none";
            copiedSpan.textContent = `âœ… å·²å¤åˆ¶ã€${cat}ã€‘çš„å…‘æ¢ç ï¼`;

            copyBtn.onclick = ()=>{
                navigator.clipboard.writeText(codes.join("\n")).then(()=>{
                    copiedSpan.style.display="inline";
                    // setTimeout(()=>{copiedSpan.style.display="none";},2500);
                });
            };

            header.appendChild(copyBtn);
            header.appendChild(copiedSpan);
            card.appendChild(header);

            const ta = document.createElement("textarea");
            ta.className = "codes";
            ta.readOnly = true;
            ta.value = codes.join("\n");
            card.appendChild(ta);
            out.appendChild(card);
        });
    }

    function copyAll(){
        const out = document.getElementById("output");
        const textareas = out.querySelectorAll("textarea.codes");
        const all = Array.from(textareas).map(t=>t.value).filter(Boolean).join("\n");
        if(!all){ alert("æ²¡æœ‰å¯å¤åˆ¶çš„å…‘æ¢ç "); return; }
        navigator.clipboard.writeText(all).then(()=>alert("å·²å¤åˆ¶æ‰€æœ‰å…‘æ¢ç "));
    }
</script>
</body>
</html>
