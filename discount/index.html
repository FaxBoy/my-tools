
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>折后价生成器</title>
  <style>
    body{font-family:"Microsoft YaHei",Arial,sans-serif;background:#f6f8fb;color:#222;padding:18px;max-width:900px;margin:24px auto;}
    h1{color:#0b66c3;margin-bottom:6px}
    .card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(12,36,80,0.06);margin-bottom:18px}
    label{display:block;margin-top:10px;font-weight:600}
    input[type="text"], input[type="number"]{width:100%;padding:8px 10px;border:1px solid #dfe6ef;border-radius:6px;font-size:15px;box-sizing:border-box}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .controls{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    button{background:#0b66c3;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600}
    button.secondary{background:#eef3fb;color:#0b66c3;border:1px solid #cfe0fb}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px 10px;border-bottom:1px solid #f0f3f8;text-align:left;font-size:14px}
    th{background:#f7fbff;color:#0b66c3}
    .muted{color:#666;font-size:13px}
    .small{font-size:13px}
    .note{margin-top:8px;color:#666}
    .inline{display:inline-block}
    @media (max-width:640px){ .row{flex-direction:column} .controls{flex-direction:column} }
  </style>
</head>
<body>
  <h1>折后价生成器</h1>
  <div class="card">
    <div class="small muted">输入原价与折扣区间（默认 0.74 - 0.88），会生成区间内每个折扣对应的折后价。</div>

    <label>原价（支持四则运算，例如 <code>100/2+5</code>）：</label>
    <input id="priceInput" type="text" placeholder="例如：79 或 100/2+5" value="79" />

    <div class="row" style="margin-top:6px;">
      <div class="col">
        <label>折扣最小值（小数）</label>
        <input id="minDiscount" type="text" placeholder="例如 0.74" value="0.74" />
      </div>
      <div class="col">
        <label>折扣最大值（小数）</label>
        <input id="maxDiscount" type="text" placeholder="例如 0.88" value="0.88" />
      </div>
      <div style="width:140px">
        <label>步长（step）</label>
        <input id="step" type="text" placeholder="例如 0.01" value="0.01" />
      </div>
    </div>

    <div class="controls">
      <button id="genBtn">生成折后价</button>
      <button id="copyBtn" class="secondary">复制结果</button>
      <button id="csvBtn" class="secondary">导出 CSV</button>
      <button id="resetBtn" class="secondary">重置示例</button>
      <div style="flex:1" class="note muted">如果你想包含端点，请确保输入的 min 和 max 是你期望的值；步长决定生成的折扣间隔。</div>
    </div>
  </div>

  <div id="output" class="card" style="display:none;">
    <div id="summary" class="small muted"></div>
    <table id="resultTable" aria-live="polite">
      <thead>
        <tr>
          <th>#</th>
          <th>折扣</th>
          <th>折扣(%)</th>
          <th>折后价</th>
          <th>节省金额</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // 安全求值：只允许数字、运算符和小数点与空格、括号
    function safeEval(expr) {
      if (expr === null || expr === undefined) return NaN;
      expr = String(expr).trim();
      if (expr.length === 0) return NaN;
      // 允许 0-9 + - * / . ( ) 空格
      if (!/^[0-9+\-*/().\s]+$/.test(expr)) return NaN;
      try {
        return Function('"use strict";return (' + expr + ')')();
      } catch (e) {
        return NaN;
      }
    }

    function toFixedNumber(n, decimals=2) {
      // 避免浮点精度问题
      const p = Math.pow(10, decimals);
      return Math.round((Number(n) + Number.EPSILON) * p) / p;
    }

    function generateList() {
      const priceExpr = document.getElementById('priceInput').value.trim();
      const rawMin = document.getElementById('minDiscount').value.trim();
      const rawMax = document.getElementById('maxDiscount').value.trim();
      const rawStep = document.getElementById('step').value.trim();

      const price = safeEval(priceExpr);
      const minD = safeEval(rawMin);
      const maxD = safeEval(rawMax);
      const step = safeEval(rawStep);

      const output = document.getElementById('output');
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = '';

      if (isNaN(price) || price <= 0) {
        alert('请输入合法的原价（正数，可带算式）。');
        return;
      }
      if (isNaN(minD) || isNaN(maxD) || isNaN(step) || step <= 0) {
        alert('请输入合法的折扣区间与步长（均为正数）。');
        return;
      }
      if (minD > maxD) {
        alert('折扣最小值不能大于最大值。');
        return;
      }
      // 防止步长太小导致超长列表，限制最大生成项为 2000
      const stepsCountEst = Math.floor((maxD - minD) / step) + 1;
      if (stepsCountEst > 2000) {
        if (!confirm('将生成 ' + stepsCountEst + ' 项，可能会比较慢，确认继续？')) return;
      }

      // 生成折扣数组（包含两端）
      const discounts = [];
      // 为避免累加浮点误差，按整数计数
      const scale = Math.max(1, Math.round(1 / step));
      // If step is not a neat inverse, compute scale as 10^decimals where decimals = max decimals in step
      function decimalsCount(x){
        const s = String(x);
        if (s.indexOf('.') === -1) return 0;
        return s.split('.')[1].length;
      }
      const decs = Math.max(decimalsCount(String(step)), decimalsCount(String(minD)), decimalsCount(String(maxD)));
      const intScale = Math.pow(10, decs);
      const iMin = Math.round(minD * intScale);
      const iMax = Math.round(maxD * intScale);
      const iStep = Math.round(step * intScale);
      if (iStep <= 0) {
        alert('步长太小或无法解析，请改为 0.01 或 0.001 等。');
        return;
      }

      for (let iv = iMin; iv <= iMax; iv += iStep) {
        const d = iv / intScale;
        // 保证 d 在 [minD, maxD] 的数值范围内（避免浮点）
        if (d + 1e-12 < minD) continue;
        if (d - 1e-12 > maxD) continue;
        discounts.push(d);
        // safety: prevent infinite loop
        if (discounts.length > 20000) break;
      }

      // 填表
      let idx = 0;
      for (const d of discounts) {
        idx++;
        const priceAfter = toFixedNumber(price * d, 2);
        const saved = toFixedNumber(price - priceAfter, 2);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx}</td>
                        <td>${d}</td>
                        <td>${toFixedNumber(d*100,2)}%</td>
                        <td>￥${priceAfter.toFixed(2)}</td>
                        <td>￥${saved.toFixed(2)}</td>`;
        tbody.appendChild(tr);
      }

      // summary
      const summary = document.getElementById('summary');
      summary.innerHTML = `原价：<strong>￥${toFixedNumber(price,2).toFixed(2)}</strong> ，折扣区间：<strong>${minD} ~ ${maxD}</strong> ，步长：<strong>${step}</strong> ，共 <strong>${discounts.length}</strong> 项。`;
      output.style.display = discounts.length ? 'block' : 'none';
    }

    // Export CSV
    function exportCSV() {
      const table = document.getElementById('resultTable');
      const rows = Array.from(table.querySelectorAll('tr'));
      if (rows.length <= 1) { alert('当前没有可导出的数据，请先生成。'); return; }
      const csv = [];
      for (const r of rows) {
        const cols = Array.from(r.querySelectorAll('th,td')).map(c => '"' + c.textContent.replace(/"/g,'""') + '"');
        csv.push(cols.join(','));
      }
      const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'discount-list.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // Copy to clipboard (text)
    function copyResult() {
      const rows = Array.from(document.querySelectorAll('#resultTable tr'));
      if (rows.length <= 1) { alert('当前没有可复制的数据，请先生成。'); return; }
      const lines = rows.map(r => Array.from(r.querySelectorAll('th,td')).map(c => c.textContent.trim()).join('\t'));
      const text = lines.join('\n');
      navigator.clipboard.writeText(text).then(() => {
        alert('已复制到剪贴板！');
      }, () => alert('复制失败，请手动选中并复制。'));
    }

    document.getElementById('genBtn').addEventListener('click', generateList);
    document.getElementById('csvBtn').addEventListener('click', exportCSV);
    document.getElementById('copyBtn').addEventListener('click', copyResult);
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('priceInput').value = '79';
      document.getElementById('minDiscount').value = '0.74';
      document.getElementById('maxDiscount').value = '0.88';
      document.getElementById('step').value = '0.01';
      document.getElementById('output').style.display = 'none';
      document.querySelector('#resultTable tbody').innerHTML = '';
      document.getElementById('summary').innerText = '';
    });

    // 允许回车生成
    ['priceInput','minDiscount','maxDiscount','step'].forEach(id => {
      document.getElementById(id).addEventListener('keydown', (e) => {
        if (e.key === 'Enter') generateList();
      });
    });

  </script>
</body>
</html>
